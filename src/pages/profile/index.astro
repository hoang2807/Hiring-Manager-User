---
import Layout from "@/layouts/Layout.astro";
// import user from "@/store/auth";

// console.log("id");
// console.log(user.getId());
let fullName;
let phone;
let email;
if (Astro.cookies.has("id")) {
  const id = Astro.cookies.get("id")?.value;

  const res = await fetch(`${import.meta.env.BASE_API_URL}/user/${id}`);
  const data = await res.json();
  fullName = data.data.fullName;
  phone = data.data.phone_number;
  email = data.data.email;
}
---

<Layout title="profile">
  <form class="bg-[#fff] p-5 w-1/2 mx-auto my-16 flex flex-col gap-4">
    <span class="mt-4">Họ tên</span>
    <input
      type="text"
      placeholder="Type here"
      class="input input-bordered w-full"
      id="name"
      required
      value={fullName}
    />
    <span class="mt-4">Số điện thoại</span>
    <input
      type="text"
      placeholder="Type here"
      class="input input-bordered w-full"
      pattern="[0-9]{3} [0-9]{3} [0-9]{4}"
      maxlength="12"
      id="phone"
      required
      value={phone}
    />
    <span class="pt-4">Email</span>
    <label class="input input-bordered flex items-center gap-2">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 16 16"
        fill="currentColor"
        class="w-4 h-4 opacity-70"
        ><path
          d="M2.5 3A1.5 1.5 0 0 0 1 4.5v.793c.026.009.051.02.076.032L7.674 8.51c.206.1.446.1.652 0l6.598-3.185A.755.755 0 0 1 15 5.293V4.5A1.5 1.5 0 0 0 13.5 3h-11Z"
        ></path><path
          d="M15 6.954 8.978 9.86a2.25 2.25 0 0 1-1.956 0L1 6.954V11.5A1.5 1.5 0 0 0 2.5 13h11a1.5 1.5 0 0 0 1.5-1.5V6.954Z"
        ></path></svg
      >
      <input
        type="text"
        class="grow"
        placeholder="Email"
        id="email"
        value={email}
        disabled
      />
    </label>
    <span class="mt-4">Upload avatar</span>
    <input
      type="file"
      class="file-input file-input-bordered file-input-primary w-full max-w-xs"
      id="avatar"
      accept="image/png, image/jpeg"
    />
    <span class="mt-4">Upload CV</span>
    <input
      type="file"
      class="file-input file-input-bordered file-input-primary w-full max-w-xs"
      id="upload"
      accept="application/pdf"
    />
    <button class="btn btn-primary" type="submit" id="submit">Lưu</button>
  </form>
  <div class="toast toast-top toast-end">
    <div class="alert alert-success">
      <span>Message sent successfully.</span>
    </div>
  </div>
</Layout>

<script>
  const name = document.getElementById("name") as HTMLInputElement;
  const phone = document.getElementById("phone") as HTMLInputElement;
  const button = document.getElementById("submit") as HTMLInputElement;
  const cv = document.getElementById("upload") as HTMLInputElement;
  const avatar = document.getElementById("avatar") as HTMLInputElement;

  button.addEventListener("click", (e) => {
    e.preventDefault();

    let file1, file2;
    if (cv.files && cv.files.length > 0) {
      file1 = cv.files[0];
    } else file1 = "";

    if (avatar.files && avatar.files.length > 0) {
      file2 = avatar.files[0];
    } else file2 = "";
    const formData = new FormData();
    formData.append("id", window.sessionStorage.getItem("id") || "");
    formData.append("username", name.value);
    formData.append("phone", phone.value);
    formData.append("avatar", file2);
    formData.append("cv", file1);

    fetch("http://localhost:3000/api/user", {
      method: "put",
      body: formData,
    })
      .then((res) => res.json())
      .then((data) => console.log(data))
      .catch((error) => console.log(error));

    showToast();
  });

  function showToast() {
    const toast = document.querySelector(
      ".toast:where(.toast-top)",
    ) as HTMLInputElement;
    toast.style.display = "block";
    toast.style.animation = "slideInLeft 1s";

    setTimeout(() => {
      toast.style.animation = "slideInRight 1s";
    }, 2000);

    setTimeout(() => {
      toast.style.display = "none";
    }, 3000);
  }
</script>
